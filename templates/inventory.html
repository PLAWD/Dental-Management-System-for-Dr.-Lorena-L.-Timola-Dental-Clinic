<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventory</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <style>
        .action-container {
            position: relative;
            display: inline-block;
        }

        .action-dropdown {
            display: none;
            position: absolute;
            background-color: white;
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
            z-index: 1;
        }

        .action-dropdown div {
            color: black;
            padding: 12px 16px;
            text-decoration: none;
            display: block;
        }

        .action-dropdown div:hover {
            background-color: #f1f1f1;
            cursor: pointer;
        }

        .ellipsis-icon {
            cursor: pointer;
        }

        .action-container:hover .action-dropdown {
            display: block;
        }

        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 20px;
            border: 1px solid #888;
            width: 70%;
            max-width: 700px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
            border-radius: 10px;
            overflow: auto;
        }

        .modal-button {
            background-color: grey;
            color: white;
            border: none;
            cursor: pointer;
            padding: 10px;
            border-radius: 5px;
        }

        .modal-button:hover {
            background-color: darkgrey;
        }

        #itemDropdown {
            display: none;
            border: 1px solid #ccc;
            max-height: 150px;
            overflow-y: auto;
            position: absolute;
            z-index: 1000;
            background: white;
        }

        #itemDropdown div {
            padding: 10px;
            cursor: pointer;
        }

        #itemDropdown div:hover {
            background-color: #f1f1f1;
        }

    </style>
</head>
<body>
    <div class="container">
        <button onclick="openRegisterItemModal()">Register Item</button>
        
        <!-- Add the search input here -->
        <input type="text" id="searchInput" onkeyup="filterTable()" placeholder="Search for items..">
        
        <div id="inventoryTable"></div>
    </div>

    <!-- Register Item Modal -->
    <div id="registerItemModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeRegisterItemModal()">&times;</span>
            <h2 class="modal-title">Register Item</h2>
            <form id="register-item-form" onsubmit="submitRegisterItem(event)">
                <label class="modal-label" for="item_name">Item Name:</label>
                <input class="modal-input" type="text" id="item_name" name="item_name" onkeyup="filterItems()" required>
                <div id="itemDropdown"></div>

                <label class="modal-label" for="category_id">Category:</label>
                <select class="modal-select" id="category_id" name="category_id" required></select>
                <input class="modal-input" type="text" id="new_category" placeholder="New Category">
                <button type="button" class="modal-button" onclick="addNewCategory()">Add Category</button>

                <label class="modal-label" for="variation_id">Variation (optional):</label>
                <select class="modal-select" id="variation_id" name="variation_id">
                    <option value="">No Variation</option>
                </select>
                <input class="modal-input" type="text" id="new_variation" placeholder="New Variation">
                <button type="button" class="modal-button" onclick="addNewVariation()">Add Variation</button>

                <label class="modal-label" for="stocked_quantity">Stocked Quantity:</label>
                <input class="modal-input" type="number" id="stocked_quantity" name="stocked_quantity" required>

                <label class="modal-label" for="seller_id">Seller:</label>
                <select class="modal-select" id="seller_id" name="seller_id" required></select>
                <input class="modal-input" type="text" id="new_seller" placeholder="New Seller">
                <button type="button" class="modal-button" onclick="addNewSeller()">Add Seller</button>

                <label class="modal-label" for="exact_price">Exact Price:</label>
                <input class="modal-input" type="number" step="0.01" id="exact_price" name="exact_price" required>

                <label class="modal-label" for="low_stock_threshold">Low Stock Threshold:</label>
                <input class="modal-input" type="number" id="low_stock_threshold" name="low_stock_threshold" required>
                <button class="modal-button" type="submit">Submit</button>
            </form>
        </div>
    </div>

    <!-- Item Details Modal -->
    <div id="itemDetailsModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeItemDetailsModal()">&times;</span>
            <h2 class="modal-title">Item Details</h2>
            <div>
                <p><strong>Item Name:</strong> <span id="detailItemName"></span></p>
                <p><strong>Item Category:</strong> <span id="detailCategory"></span></p>
                <p><strong>Variation Description:</strong> <span id="detailVariationDescription"></span></p>
                <p><strong>Item Variation:</strong> <span id="detailVariation"></span></p>
                <p><strong>Min Price:</strong> <span id="detailMinPrice"></span></p>
                <p><strong>Max Price:</strong> <span id="detailMaxPrice"></span></p>
                <input type="hidden" id="item_id" name="item_id">
                <button class="modal-button" onclick="editVariationDescription()">Edit Variation Description</button>
                <div id="editVariationDescriptionDiv" style="display: none;">
                    <textarea id="editVariationDescriptionTextarea"></textarea>
                    <button class="modal-button" onclick="saveVariationDescription()">Save Variation Description</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Item Modal -->
    <div id="editItemModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeEditItemModal()">&times;</span>
            <h2 class="modal-title">Edit Item</h2>
            <form id="edit-item-form" onsubmit="submitEditItem(event)">
                <input type="hidden" id="edit_inventory_id" name="inventory_id">
                <p><strong>Item Name:</strong> <span id="editDetailItemName"></span></p>
                <p><strong>Category:</strong> <span id="editDetailCategory"></span></p>
                <p><strong>Variation:</strong> <span id="editDetailVariation"></span></p>

                <label class="modal-label" for="edit_stocked_quantity">Stocked Quantity:</label>
                <input class="modal-input" type="number" id="edit_stocked_quantity" name="stocked_quantity" required>

                <label class="modal-label" for="edit_seller_id">Seller:</label>
                <select class="modal-select" id="edit_seller_id" name="seller_id" required></select>

                <label class="modal-label" for="edit_exact_price">Exact Price:</label>
                <input class="modal-input" type="number" step="0.01" id="edit_exact_price" name="exact_price" required>

                <label class="modal-label" for="edit_low_stock_threshold">Low Stock Threshold:</label>
                <input class="modal-input" type="number" id="edit_low_stock_threshold" name="low_stock_threshold" required>
                <button class="modal-button" type="submit">Submit</button>
            </form>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            loadInventory();
            loadCategories();
            loadVariations();
            loadSellers();
            loadItems();
        });

        function loadInventory() {
            fetch('/get_inventory')
                .then(response => response.json())
                .then(data => {
                    let table = '<table><tr><th>Item Name</th><th>Category</th><th>Variation</th><th>Stocked Quantity</th><th>Seller</th><th>Exact Price</th><th>Low Stock Threshold</th><th>Added By</th><th>Role</th><th>Date Added</th><th>Time Added</th><th>Action</th></tr>';
                    data.forEach(item => {
                        if (item.is_disabled !== 1) { // Check if the item is not disabled
                            const role = item.added_by_role === 1 ? 'Admin' : 'User';
                            table += `<tr>
                                <td><a href="#" onclick="showItemDetails(${item.inventory_id})">${item.item_name}</a></td>
                                <td>${item.category_name}</td>
                                <td>${item.variation_name || 'No Variation'}</td>
                                <td>${item.stocked_quantity}</td>
                                <td>${item.seller_name}</td>
                                <td>${item.exact_price}</td>
                                <td>${item.low_stock_threshold}</td>
                                <td>${item.added_by}</td>
                                <td>${role}</td>
                                <td>${item.date_added}</td>
                                <td>${item.time_added}</td>
                                <td>
                                    <div class="action-container">
                                        <span class="ellipsis-icon">â‹®</span>
                                        <div class="action-dropdown">
                                            <div onclick="openEditItemModal(${item.inventory_id})">Edit Item</div>
                                            <div onclick="disableItem(${item.inventory_id})">Disable Item</div>
                                        </div>
                                    </div>
                                </td>
                            </tr>`;
                        }
                    });
                    table += '</table>';
                    document.getElementById('inventoryTable').innerHTML = table;
                });
        }

        function filterTable() {
            const input = document.getElementById('searchInput');
            const filter = input.value.toLowerCase();
            const table = document.getElementById('inventoryTable').getElementsByTagName('table')[0];
            const tr = table.getElementsByTagName('tr');

            for (let i = 1; i < tr.length; i++) {
                const tds = tr[i].getElementsByTagName('td');
                let isVisible = false;

                for (let j = 0; j < tds.length - 1; j++) {
                    const td = tds[j];
                    if (td) {
                        const textValue = td.textContent || td.innerText;
                        if (textValue.toLowerCase().indexOf(filter) > -1) {
                            isVisible = true;
                            break;
                        }
                    }
                }

                tr[i].style.display = isVisible ? "" : "none";
            }
        }

        function disableItem(inventory_id) {
            fetch('/disable_item', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ inventory_id: inventory_id })
            }).then(response => response.json())
            .then(data => {
                if (data.success) {
                    loadInventory();
                } else {
                    alert('Failed to disable item: ' + data.message);
                }
            });
        }

        function loadItems() {
            fetch('/get_items')
                .then(response => response.json())
                .then(data => {
                    const uniqueItems = Array.from(new Set(data.map(item => item.item_name)))
                        .map(item_name => {
                            return data.find(item => item.item_name === item_name);
                        });
                    window.allItems = uniqueItems;
                });
        }

        function filterItems() {
            const query = document.getElementById('item_name').value.toLowerCase();
            const dropdown = document.getElementById('itemDropdown');
            dropdown.innerHTML = '';
            if (query.length > 0) {
                const filteredItems = window.allItems.filter(item => item.item_name.toLowerCase().includes(query));
                if (filteredItems.length > 0) {
                    dropdown.style.display = 'block';
                    filteredItems.forEach(item => {
                        const div = document.createElement('div');
                        div.textContent = item.item_name;
                        div.onclick = () => {
                            document.getElementById('item_name').value = item.item_name;
                            dropdown.style.display = 'none';
                        };
                        dropdown.appendChild(div);
                    });
                } else {
                    dropdown.style.display = 'none';
                }
            } else {
                dropdown.style.display = 'none';
            }
        }

        function openRegisterItemModal() {
            document.getElementById('register-item-form').reset(); // Clear the form
            loadCategories();
            loadVariations();
            loadSellers();
            document.getElementById('registerItemModal').style.display = 'flex';
        }

        function closeRegisterItemModal() {
            document.getElementById('registerItemModal').style.display = 'none';
        }

        function submitRegisterItem(event) {
            event.preventDefault();
            const formData = {
                item_name: document.getElementById('item_name').value,
                category_id: document.getElementById('category_id').value,
                variation_id: document.getElementById('variation_id').value || null,
                stocked_quantity: document.getElementById('stocked_quantity').value,
                seller_id: document.getElementById('seller_id').value,
                exact_price: document.getElementById('exact_price').value,
                low_stock_threshold: document.getElementById('low_stock_threshold').value
            };

            fetch('/register_item', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(formData)
            }).then(response => response.json())
            .then(data => {
                if (data.success) {
                    loadInventory();
                    closeRegisterItemModal();
                } else {
                    alert('Failed to register item: ' + data.message);
                }
            });
        }

        function showItemDetails(inventory_id) {
            fetch(`/get_item/${inventory_id}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert(data.error);
                        return;
                    }

                    const detailItemName = document.getElementById('detailItemName');
                    const detailCategory = document.getElementById('detailCategory');
                    const detailVariationDescription = document.getElementById('detailVariationDescription');
                    const detailVariation = document.getElementById('detailVariation');
                    const detailMinPrice = document.getElementById('detailMinPrice');
                    const detailMaxPrice = document.getElementById('detailMaxPrice');
                    const itemId = document.getElementById('item_id');

                    if (detailItemName && detailCategory && detailVariationDescription && detailVariation && detailMinPrice && detailMaxPrice && itemId) {
                        detailItemName.textContent = data.item_name;
                        detailCategory.textContent = data.category_name;
                        detailVariationDescription.textContent = data.variation_description;
                        detailVariation.textContent = data.variation_name || 'No Variation';
                        detailMinPrice.textContent = data.min_price;
                        detailMaxPrice.textContent = data.max_price;
                        itemId.value = inventory_id;  // Store the inventory_id in a hidden field

                        document.getElementById('itemDetailsModal').style.display = 'flex';
                    } else {
                        console.error('One or more elements are missing in the DOM.');
                    }
                })
                .catch(error => {
                    console.error('Error fetching item details:', error);
                });
        }

        function openEditItemModal(inventory_id) {
            fetch(`/get_item/${inventory_id}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert(data.error);
                        return;
                    }

                    const editDetailItemName = document.getElementById('editDetailItemName');
                    const editDetailCategory = document.getElementById('editDetailCategory');
                    const editDetailVariation = document.getElementById('editDetailVariation');
                    const editStockedQuantity = document.getElementById('edit_stocked_quantity');
                    const editSellerId = document.getElementById('edit_seller_id');
                    const editExactPrice = document.getElementById('edit_exact_price');
                    const editLowStockThreshold = document.getElementById('edit_low_stock_threshold');
                    const editInventoryId = document.getElementById('edit_inventory_id');

                    if (editDetailItemName && editDetailCategory && editDetailVariation && editStockedQuantity && editSellerId && editExactPrice && editLowStockThreshold && editInventoryId) {
                        editDetailItemName.textContent = data.item_name;
                        editDetailCategory.textContent = data.category_name;
                        editDetailVariation.textContent = data.variation_name || 'No Variation';
                        editStockedQuantity.value = data.stocked_quantity;
                        editSellerId.value = data.seller_id;
                        editExactPrice.value = data.exact_price;
                        editLowStockThreshold.value = data.low_stock_threshold;
                        editInventoryId.value = inventory_id;  // Store the inventory_id in a hidden field

                        loadSellers(); // Reload sellers to update the dropdown
                        document.getElementById('editItemModal').style.display = 'flex';
                    } else {
                        console.error('One or more elements are missing in the DOM.');
                    }
                })
                .catch(error => {
                    console.error('Error fetching item details:', error);
                });
        }   


        function closeEditItemModal() {
            document.getElementById('editItemModal').style.display = 'none';
        }


        function submitEditItem(event) {
            event.preventDefault();
            const formData = {
                inventory_id: document.getElementById('edit_inventory_id').value,
                stocked_quantity: document.getElementById('edit_stocked_quantity').value,
                seller_id: document.getElementById('edit_seller_id').value,
                exact_price: document.getElementById('edit_exact_price').value,
                low_stock_threshold: document.getElementById('edit_low_stock_threshold').value
            };

            fetch('/edit_item', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(formData)
            }).then(response => response.json())
            .then(data => {
                if (data.success) {
                    loadInventory();
                    closeEditItemModal();
                } else {
                    alert('Failed to edit item: ' + data.message);
                }
            });
        }

        function closeItemDetailsModal() {
            document.getElementById('itemDetailsModal').style.display = 'none';
        }

        function editVariationDescription() {
            document.getElementById('editVariationDescriptionDiv').style.display = 'block';
            document.getElementById('editVariationDescriptionTextarea').value = document.getElementById('detailVariationDescription').textContent;
        }

        function saveVariationDescription() {
            const newVariationDescription = document.getElementById('editVariationDescriptionTextarea').value;
            const itemId = document.getElementById('item_id').value;  // Get the stored item_id
            fetch('/update_variation_description', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ item_id: itemId, variation_description: newVariationDescription })
            }).then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('detailVariationDescription').textContent = newVariationDescription;
                    document.getElementById('editVariationDescriptionDiv').style.display = 'none';
                } else {
                    alert('Failed to update variation description: ' + data.message);
                }
            });
        }

        function loadCategories() {
            fetch('/get_categories')
                .then(response => response.json())
                .then(data => {
                    let select = document.getElementById('category_id');
                    select.innerHTML = ''; // Clear existing options
                    data.forEach(category => {
                        let option = document.createElement('option');
                        option.value = category.category_id;
                        option.text = category.category_name;
                        select.add(option);
                    });
                });
        }

        function loadVariations() {
            fetch('/get_variations')
                .then(response => response.json())
                .then(data => {
                    let select = document.getElementById('variation_id');
                    select.innerHTML = '<option value="">No Variation</option>'; // Clear existing options and add default
                    data.forEach(variation => {
                        let option = document.createElement('option');
                        option.value = variation.variation_id;
                        option.text = variation.variation_name;
                        select.add(option);
                    });
                });
        }

        function loadSellers() {
            fetch('/get_sellers')
                .then(response => response.json())
                .then(data => {
                    let select = document.getElementById('seller_id');
                    select.innerHTML = ''; // Clear existing options
                    data.forEach(seller => {
                        let option = document.createElement('option');
                        option.value = seller.seller_id;
                        option.text = seller.seller_name;
                        select.add(option);
                    });

                    // Also update the sellers in the edit modal
                    let editSelect = document.getElementById('edit_seller_id');
                    editSelect.innerHTML = ''; // Clear existing options
                    data.forEach(seller => {
                        let option = document.createElement('option');
                        option.value = seller.seller_id;
                        option.text = seller.seller_name;
                        editSelect.add(option);
                    });
                });
        }

        function addNewCategory() {
            const newCategory = document.getElementById('new_category').value.trim();
            if (newCategory === '') {
                alert('Please enter a category name.');
                return;
            }
            fetch('/add_category', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ category_name: newCategory })
            }).then(response => response.json())
            .then(data => {
                if (data.success) {
                    loadCategories();
                    document.getElementById('new_category').value = '';
                } else {
                    alert('Failed to add category: ' + data.message);
                }
            });
        }

        function addNewVariation() {
            const newVariation = document.getElementById('new_variation').value.trim();
            if (newVariation === '') {
                alert('Please enter a variation name.');
                return;
            }
            fetch('/add_variation', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ variation_name: newVariation })
            }).then(response => response.json())
            .then(data => {
                if (data.success) {
                    loadVariations();
                    document.getElementById('new_variation').value = '';
                } else {
                    alert('Failed to add variation: ' + data.message);
                }
            });
        }

        function addNewSeller() {
            const newSeller = document.getElementById('new_seller').value.trim();
            if (newSeller === '') {
                alert('Please enter a seller name.');
                return;
            }
            fetch('/add_seller', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ seller_name: newSeller })
            }).then(response => response.json())
            .then(data => {
                if (data.success) {
                    loadSellers();
                    document.getElementById('new_seller').value = '';
                } else {
                    alert('Failed to add seller: ' + data.message);
                }
            });
        }
    </script>
</body>
</html>
