<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.10.2/fullcalendar.min.css" />
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.10.2/fullcalendar.min.js"></script>
</head>
<body class="dashboard">
    <div class="sidebar-tab" id="sidebarTab">‚ò∞</div>
    <div id="sidebar" class="sidebar">
        <ul>
            <li><a href="{{ url_for('dashboard') }}">Dashboard</a></li>
            <li><a href="{{ url_for('users') }}">Users</a></li>
            <li><a href="{{ url_for('patients') }}">Patients</a></li>
            <li><a href="#">Records</a></li>
            <li><a href="#">Maintenance</a></li>
            <li><a href="#">Inventory</a></li>
            <li><a href="{{ url_for('reports') }}">Reports</a></li>
            <li><a href="#">Settings</a></li>
        </ul>
        <ul class="logout">
            <li><a href="{{ url_for('logout') }}">Logout</a></li>
        </ul>
    </div>
    <header>
        <div class="header-left">
            <h2>‚Äé ‚Äé ‚Äé ‚Äé ‚Äé ‚Äé ‚ÄéWelcome, {{ first_name }}!</h2>
        </div>
        <div class="header-center">
            <form class="search-form" action="{{ url_for('search') }}" method="get">
                <input type="text" name="query" placeholder="Search...">
                <button type="submit" class="search-btn">üîç</button>
            </form>
        </div>
    </header>
    <div class="main-content">
        <div id="calendar"></div>
        <button class="create-appointment-btn" onclick="openCreateAppointmentModal()">Create Appointment</button>
    </div>

    <!-- Create Appointment Modal -->
    <div id="createAppointmentModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeCreateAppointmentModal()">&times;</span>
            <h2>Create Appointment</h2>
            <form id="create-appointment-form" action="{{ url_for('submit_appointment') }}" method="POST">
                <label for="patient_id">Patient:</label>
                <select id="patient_id" name="patient_id" required>
                    {% for patient in patients %}
                    <option value="{{ patient.patient_id }}">{{ patient.first_name }} {{ patient.middle_name }} {{ patient.last_name }}</option>
                    {% endfor %}
                </select>
                <label for="appointment_date">Date:</label>
                <input type="date" id="appointment_date" name="appointment_date" required>
                <label for="start_time">Start Time:</label>
                <input type="time" id="start_time" name="start_time" required>
                <label for="end_time">End Time:</label>
                <input type="time" id="end_time" name="end_time" required>
                <label for="appointment_type">Type:</label>
                <input type="text" id="appointment_type" name="appointment_type" required>
                <label for="chief_complaints">Chief Complaints:</label>
                <input type="text" id="chief_complaints" name="chief_complaints" required>
                <label for="procedures">Procedures:</label>
                <input type="text" id="procedures" name="procedures" required>
                <label for="dentist_id">Dentist:</label>
                <select id="dentist_id" name="dentist_id" required>
                    {% for dentist in dentists %}
                    <option value="{{ dentist.dentist_id }}">{{ dentist.first_name }} {{ dentist.last_name }}</option>
                    {% endfor %}
                </select>
                <button type="submit">Create</button>
            </form>
        </div>
    </div>

    <!-- View Appointment Modal -->
    <div id="viewAppointmentModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeViewAppointmentModal()">&times;</span>
            <h2>View Appointment</h2>
            <div id="appointment-details"></div>
            <button onclick="openEditAppointmentModal()">Edit Appointment</button>
            <button onclick="cancelAppointment()">Cancel Appointment</button>
        </div>
    </div>

    <!-- Edit Appointment Modal -->
    <div id="editAppointmentModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeEditAppointmentModal()">&times;</span>
            <h2>Edit Appointment</h2>
            <form id="edit-appointment-form" action="{{ url_for('update_appointment') }}" method="POST">
                <input type="hidden" id="edit_appointment_id" name="appointment_id">
                <label for="appointment_date">Date:</label>
                <input type="date" id="edit_appointment_date" name="appointment_date" required>
                <label for="start_time">Start Time:</label>
                <input type="time" id="edit_start_time" name="start_time" required>
                <label for="end_time">End Time:</label>
                <input type="time" id="edit_end_time" name="end_time" required>
                <label for="appointment_type">Type:</label>
                <input type="text" id="edit_appointment_type" name="appointment_type" required>
                <label for="chief_complaints">Chief Complaints:</label>
                <input type="text" id="edit_chief_complaints" name="chief_complaints" required>
                <label for="procedures">Procedures:</label>
                <input type="text" id="edit_procedures" name="procedures" required>
                <label for="dentist_id">Dentist:</label>
                <select id="edit_dentist_id" name="dentist_id" required>
                    {% for dentist in dentists %}
                    <option value="{{ dentist.dentist_id }}">{{ dentist.first_name }} {{ dentist.last_name }}</option>
                    {% endfor %}
                </select>
                <button type="submit">Update</button>
            </form>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const sidebar = document.getElementById('sidebar');
            const sidebarTab = document.getElementById('sidebarTab');
            const mainContent = document.querySelector('.main-content');

            sidebarTab.addEventListener('click', function () {
                sidebar.classList.toggle('show');
                mainContent.classList.toggle('shifted');
                sidebarTab.style.display = 'none';
            });

            document.addEventListener('click', function (event) {
                if (!sidebar.contains(event.target) && !sidebarTab.contains(event.target)) {
                    sidebar.classList.remove('show');
                    mainContent.classList.remove('shifted');
                    sidebarTab.style.display = 'block';
                }
            });

            $.getJSON('{{ url_for("get_appointments") }}', function (data) {
                $('#calendar').fullCalendar({
                    header: {
                        left: 'prev,next today',
                        center: 'title',
                        right: 'month,agendaWeek,agendaDay'
                    },
                    navLinks: true,
                    editable: true,
                    eventLimit: true,
                    events: data,
                    eventClick: function (event) {
                        viewAppointment(event.id);
                    }
                });
            });
        });

        function openCreateAppointmentModal() {
            document.getElementById('createAppointmentModal').style.display = 'block';
        }

        function closeCreateAppointmentModal() {
            document.getElementById('createAppointmentModal').style.display = 'none';
        }

        function viewAppointment(appointmentId) {
            $.getJSON('{{ url_for("view_appointment") }}', { id: appointmentId }, function (data) {
                const details = document.getElementById('appointment-details');
                details.innerHTML = `
                    <p>Patient: ${data.patient_name}</p>
                    <p>Date: ${data.appointment_date}</p>
                    <p>Start Time: ${data.start_time}</p>
                    <p>End Time: ${data.end_time}</p>
                    <p>Type: ${data.appointment_type}</p>
                    <p>Chief Complaints: ${data.chief_complaints}</p>
                    <p>Procedures: ${data.procedures}</p>
                    <p>Dentist: ${data.dentist_name}</p>
                `;
                document.getElementById('viewAppointmentModal').style.display = 'block';
                document.getElementById('edit_appointment_id').value = appointmentId;
            });
        }

        function openEditAppointmentModal() {
            const appointmentId = document.getElementById('edit_appointment_id').value;
            $.getJSON('{{ url_for("view_appointment") }}', { id: appointmentId }, function (data) {
                document.getElementById('edit_appointment_date').value = data.appointment_date;
                document.getElementById('edit_start_time').value = data.start_time;
                document.getElementById('edit_end_time').value = data.end_time;
                document.getElementById('edit_appointment_type').value = data.appointment_type;
                document.getElementById('edit_chief_complaints').value = data.chief_complaints;
                document.getElementById('edit_procedures').value = data.procedures;
                document.getElementById('edit_dentist_id').value = data.dentist_id;
                document.getElementById('viewAppointmentModal').style.display = 'none';
                document.getElementById('editAppointmentModal').style.display = 'block';
            });
        }

        function closeEditAppointmentModal() {
            document.getElementById('editAppointmentModal').style.display = 'none';
        }

        function closeViewAppointmentModal() {
            document.getElementById('viewAppointmentModal').style.display = 'none';
        }

        function cancelAppointment() {
            const appointmentId = document.getElementById('edit_appointment_id').value;
            if (confirm('Are you sure you want to cancel this appointment?')) {
                $.post('{{ url_for("cancel_appointment") }}', { id: appointmentId }, function (data) {
                    if (data.success) {
                        $('#calendar').fullCalendar('refetchEvents');
                        closeViewAppointmentModal();
                    } else {
                        alert('Failed to cancel appointment.');
                    }
                });
            }
        }
    </script>
</body>
</html>

