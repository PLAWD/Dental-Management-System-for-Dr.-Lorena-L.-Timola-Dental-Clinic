<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Intraoral Examination</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <style>
        .price-button {
            position: relative;
            padding: 10px 20px;
            background-color: #8B4513;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .price-button:hover {
            background-color: #D2691E;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.4);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 600px;
            border-radius: 10px;
            position: relative;
        }
        .close {
            position: absolute;
            right: 20px;
            top: 10px;
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .form-group input[type="text"],
        .form-group input[type="number"],
        .form-group select {
            width: 100%;
            padding: 8px;
            margin-top: 5px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
    </style>
</head>
<body class="intraoral-page">
    <div class="sidebar-tab" id="sidebarTab">â˜°</div>
    <div id="sidebar" class="sidebar">
        <ul>
            <li><a href="{{ url_for('dashboard') }}">Dashboard</a></li>
            <li><a href="{{ url_for('profile') }}">Profile</a></li>
            <li><a href="{{ url_for('users') }}">Users</a></li>
            <li><a href="{{ url_for('treatments') }}">Treatment</a></li>
            <li class="dropdown">
                <a href="#">Records</a>
                <div class="dropdown-content">
                    <a href="{{ url_for('patients') }}">Patient Records</a>
                    <a href="{{ url_for('appointment_records') }}">Appointment Records</a>
                    <a href="{{ url_for('treatment_records') }}">Treatment Records</a>
                </div>
            </li>
            <li><a href="{{ url_for('maintenance') }}">Maintenance</a></li>
            <li><a href="{{ url_for('inventory') }}">Inventory</a></li>
            <li><a href="{{ url_for('reports') }}">Reports</a></li>
            <li><a href="{{ url_for('payments') }}">Payments</a></li>
            <br>
            <br>
            <br>
            <br>
            <br>
            <br>
            <li><a href="{{ url_for('help') }}">Help</a></li>
            <li><a href="{{ url_for('about') }}">About</a></li>
            <li><a href="{{ url_for('logout') }}">Logout</a></li>
        </ul>
    </div>
    <div class="main-content">
        <div class="container">
            <div class="tab-container">
                <button class="tab active" onclick="openTab(event, 'consent-form')">Consent Form</button>
                <button class="tab" onclick="openTab(event, 'medical-history')">Medical History</button>
                <button class="tab" onclick="openTab(event, 'add-items')">Add Items</button>
                <button class="tab" onclick="openTab(event, 'enter-diagnosis')">Enter Diagnosis</button>
                <button class="tab" onclick="openTab(event, 'generate_billing')">Billings</button>
            </div>

            <div class="exam-form">
                <div class="teeth-diagram">
                    <div class="legend">
                        <button class="price-button" onclick="openPriceModal()">Set Prices</button>
                        <label><input type="checkbox" class="condition-checkbox" data-code="Cl"> Cleaning </label><br>
                    </div>
                    <div class="teeth-section">
                        <div class="teeth-header">Upper Temporary Teeth</div>
                        <div class="teeth-row">
                            <!-- Upper temporary teeth row -->
                            {% for number in [55, 54, 53, 52, 51, 61, 62, 63, 64, 65] %}
                            <div class="tooth-container">
                                <div class="tooth-box" onclick="openModal(this, {{ number }})">
                                    <text class="condition-text" x="50" y="55" text-anchor="middle" dominant-baseline="middle"></text>
                                </div>
                                <div class="tooth">
                                    <svg viewBox="0 0 100 100" class="interactive-circle">
                                        <path class="outerCircle" d="M50 50 L50 0 A50 50 0 0 1 100 50 z"></path>
                                        <path class="outerCircle" d="M50 50 L100 50 A50 50 0 0 1 50 100 z"></path>
                                        <path class="outerCircle" d="M50 50 L50 100 A50 50 0 0 1 0 50 z"></path>
                                        <path class="outerCircle" d="M50 50 L0 50 A50 50 0 0 1 50 0 z"></path>
                                        <circle class="outerCircle" cx="50" cy="50" r="20"></circle>
                                        <text x="50" y="-20" text-anchor="middle" dominant-baseline="middle">{{ number }}</text>
                                    </svg>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    <div class="teeth-section">
                        <div class="teeth-header">Permanent Teeth</div>
                        <div class="teeth-row">
                            <!-- Permanent teeth upper row -->
                            {% for number in [18, 17, 16, 15, 14, 13, 12, 11, 21, 22, 23, 24, 25, 26, 27, 28] %}
                            <div class="tooth-container">
                                <div class="tooth-box" onclick="openModal(this, {{ number }})">
                                    <text class="condition-text" x="50" y="55" text-anchor="middle" dominant-baseline="middle"></text>
                                </div>
                                <div class="tooth">
                                    <svg viewBox="0 0 100 100" class="interactive-circle">
                                        <path class="outerCircle" d="M50 50 L50 0 A50 50 0 0 1 100 50 z"></path>
                                        <path class="outerCircle" d="M50 50 L100 50 A50 50 0 0 1 50 100 z"></path>
                                        <path class="outerCircle" d="M50 50 L50 100 A50 50 0 0 1 0 50 z"></path>
                                        <path class="outerCircle" d="M50 50 L0 50 A50 50 0 0 1 50 0 z"></path>
                                        <circle class="outerCircle" cx="50" cy="50" r="20"></circle>
                                        <text x="50" y="-20" text-anchor="middle" dominant-baseline="middle">{{ number }}</text>
                                    </svg>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        <div class="teeth-row">
                            <!-- Permanent teeth lower row -->
                            {% for number in [48, 47, 46, 45, 44, 43, 42, 41, 31, 32, 33, 34, 35, 36, 37, 38] %}
                            <div class="tooth-container">
                                 <div class="tooth-box" onclick="openModal(this, {{ number }})">
                                    <text class="condition-text" x="50" y="55" text-anchor="middle" dominant-baseline="middle"></text>
                                </div>
                                <div class="tooth">
                                    <svg viewBox="0 0 100 100" class="interactive-circle">
                                        <path class="outerCircle" d="M50 50 L50 0 A50 50 0 0 1 100 50 z"></path>
                                        <path class="outerCircle" d="M50 50 L100 50 A50 50 0 0 1 50 100 z"></path>
                                        <path class="outerCircle" d="M50 50 L50 100 A50 50 0 0 1 0 50 z"></path>
                                        <path class="outerCircle" d="M50 50 L0 50 A50 50 0 0 1 50 0 z"></path>
                                        <circle class="outerCircle" cx="50" cy="50" r="20"></circle>
                                        <text x="50" y="-20" text-anchor="middle" dominant-baseline="middle">{{ number }}</text>
                                    </svg>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    <div class="teeth-section">
                        <div class="teeth-header">Lower Temporary Teeth</div>
                        <div class="teeth-row">
                            <!-- Lower temporary teeth row -->
                            {% for number in [85, 84, 83, 82, 81, 71, 72, 73, 74, 75] %}
                            <div class="tooth-container">
                                <div class="tooth-box" onclick="openModal(this, {{ number }})">
                                    <text class="condition-text" x="50" y="55" text-anchor="middle" dominant-baseline="middle"></text>
                                </div>
                                <div class="tooth">
                                    <svg viewBox="0 0 100 100" class="interactive-circle">
                                        <path class="outerCircle" d="M50 50 L50 0 A50 50 0 0 1 100 50 z"></path>
                                        <path class="outerCircle" d="M50 50 L100 50 A50 50 0 0 1 50 100 z"></path>
                                        <path class="outerCircle" d="M50 50 L50 100 A50 50 0 0 1 0 50 z"></path>
                                        <path class="outerCircle" d="M50 50 L0 50 A50 50 0 0 1 50 0 z"></path>
                                        <circle class="outerCircle" cx="50" cy="50" r="20"></circle>
                                        <text x="50" y="-20" text-anchor="middle" dominant-baseline="middle">{{ number }}</text>
                                    </svg>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>

<!-- ////////////////////////////////// Consent form ////////////////-->

<div id="consent-form" class="tab-content" style="display:none;">
    <!-- Consent form content -->
    <div class="exam-details">
        <h3>Consent Form</h3>
        <form action="{{ url_for('generate_consent_form', patient_id=patient.patient_id) }}" method="get">
            <button type="submit" class="consent-button">Generate Consent Form</button>
        </form>
    </div>
</div>

<!-- ////////////////////////////////// Add items ////////////////-->

<div id="add-items" class="tab-content" style="display:none;">
    <!-- Add items content -->
    <div class="exam-details">
        <h3>Add Items</h3>
        <div id="items-container">
            <div class="item-row">
                <select class="item-dropdown">
                    {% for item in items %}
                    <option value="{{ item.id }}">{{ item.name }}</option>
                    {% endfor %}
                </select>
                <input type="number" class="item-quantity" placeholder="Quantity Used">
                <button type="button" class="remove-item-btn" onclick="removeItem(this)">Remove</button>
            </div>
        </div>
        <button type="button" onclick="addItem()">Add Item</button>
    </div>
</div>

<!-- ////////////////////////////////// Medical History ////////////////-->

<div id="medical-history" class="tab-content" style="display:none;">
    <!-- Medical History content -->
    <div class="exam-details">
        <h3>Medical History</h3>
        <form id="medicalHistoryForm">
            <div class="form-group">
                <input type="checkbox" id="diabetes" name="diabetes">
                <label for="diabetes">Diabetes</label>
            </div>
            <div class="form-group">
                <input type="checkbox" id="tired" name="tired">
                <label for="tired">Gets tired easily</label>
            </div>
            <div class="form-group">
                <input type="checkbox" id="urinates" name="urinates">
                <label for="urinates">Urinates frequently</label>
            </div>
            <div class="form-group">
                <input type="checkbox" id="thirsty" name="thirsty">
                <label for="thirsty">Easily gets thirsty</label>
            </div>
            <div class="form-group">
                <input type="checkbox" id="heart" name="heart">
                <label for="heart">Heart Disease</label>
            </div>
            <div class="form-group">
                <input type="checkbox" id="hepatitis" name="hepatitis">
                <label for="hepatitis">Hepatitis</label>
            </div>
            <div class="form-group">
                <input type="checkbox" id="anemia" name="anemia">
                <label for="anemia">Anemia</label>
            </div>
            <div class="form-group">
                <input type="checkbox" id="hypertension" name="hypertension">
                <label for="hypertension">Hypertension</label>
            </div>
            <div class="form-group">
                <input type="checkbox" id="allergic" name="allergic" onclick="toggleTextBox('allergic', 'allergic-specify')">
                <label for="allergic">Allergic to Anesthetic Agent</label>
                <input type="text" id="allergic-specify" name="allergic_specify" class="conditional-field" placeholder="Specify">
            </div>
            <div class="form-group">
                <input type="checkbox" id="extraction" name="extraction" onclick="toggleDatePicker('extraction', 'extraction-date')">
                <label for="extraction">Had a tooth extraction before (when was the latest?)</label>
                <input type="date" id="extraction-date" name="extraction_date" class="conditional-field">
            </div>
            <div class="form-group">
                <input type="checkbox" id="bleeds" name="bleeds">
                <label for="bleeds">Bleeds profusely after extraction</label>
            </div>
            <div class="form-group">
                <input type="checkbox" id="chest" name="chest">
                <label for="chest">Chest pain</label>
            </div>
            <div class="form-group">
                <input type="checkbox" id="asthma" name="asthma">
                <label for="asthma">Asthma</label>
            </div>
            {% if patient.sex == 'Female' %}
            <div class="form-group">
                <input type="checkbox" id="menstruation" name="menstruation">
                <label for="menstruation">Menstruation</label>
            </div>
            <div class="form-group">
                <input type="checkbox" id="pregnant" name="pregnant" onclick="toggleTextBox('pregnant', 'pregnant-months')">
                <label for="pregnant">Pregnant (how many months)</label>
                <input type="text" id="pregnant-months" name="pregnant_months" class="conditional-field" placeholder="How many months?">
            </div>
            {% endif %}
            <div class="form-group">
                <input type="checkbox" id="hospitalized" name="hospitalized" onclick="toggleTextBox('hospitalized', 'hospitalized-disease')">
                <label for="hospitalized">Hospitalized before?</label>
                <input type="text" id="hospitalized-disease" name="hospitalized_disease" class="conditional-field" placeholder="What disease?">
            </div>
            <div class="form-group">
                <input type="checkbox" id="medicine" name="medicine" onclick="toggleTextBox('medicine', 'medicine-specify')">
                <label for="medicine">Taking medicine at present</label>
                <input type="text" id="medicine-specify" name="medicine_specify" class="conditional-field" placeholder="Specify">
            </div>
            <div class="form-group">
                <input type="checkbox" id="epilepsy" name="epilepsy">
                <label for="epilepsy">Epilepsy</label>
            </div>
            <div class="submit-group">
                <button type="button" onclick="saveMedicalHistory()">Save Medical History</button>
            </div>
        </form>
    </div>
</div>

<!-- ////////////////////////////////// Enter Diagnosis ////////////////-->

<div id="enter-diagnosis" class="tab-content">
    <!-- Enter diagnosis content -->
    <div class="exam-details">
        <h3>Enter Diagnosis</h3>
        <form id="diagnosisForm">
            <div class="form-group">
                <label>Periodontal Screening</label>
                <input type="checkbox" class="diagnosis-checkbox" id="G" data-code="G">
                <label for="G"> Gingivitis </label>
                <input type="checkbox" class="diagnosis-checkbox" id="EP" data-code="EP">
                <label for="EP"> Early Periodontitis </label>
                <input type="checkbox" class="diagnosis-checkbox" id="MP" data-code="MP">
                <label for="MP"> Moderate Periodontitis </label>
                <input type="checkbox" class="diagnosis-checkbox" id="AP" data-code="AP">
                <label for="AP"> Advanced Periodontitis </label>
            </div>
            <div class="form-group">
                <label>Occlusion</label>
                <select name="occlusion">
                    <option value="">Select Class</option>
                    <option value="Class I">Class I</option>
                    <option value="Class II">Class II</option>
                    <option value="Class III">Class III</option>
                </select>
            </div>
            <div class="form-group">
                <label>Appliances</label>
                <input type="checkbox" class="diagnosis-checkbox" data-code="O"> Orthodontic
                <input type="checkbox" class="diagnosis-checkbox" data-code="S"> Stayplate
                <input type="checkbox" class="diagnosis-checkbox" data-code="OT"> Others <input type="text" name="appliance_others">
            </div>
            <div class="form-group">
                <label>TMD</label>
                <input type="checkbox" class="diagnosis-checkbox" data-code="C"> Clenching
                <input type="checkbox" class="diagnosis-checkbox" data-code="CL"> Clicking
                <input type="checkbox" class="diagnosis-checkbox" data-code="T"> Trismus
                <input type="checkbox" class="diagnosis-checkbox" data-code="MS"> Muscle spasm
            </div>
            <div class="form-group">
                <label>X-ray Taken</label>
                <input type="checkbox" class="diagnosis-checkbox" data-code="P"> Panoramic
                <input type="checkbox" class="diagnosis-checkbox" data-code="C"> Cephalometric
                <input type="checkbox" class="diagnosis-checkbox" data-code="PT"> Periapical Tth. No. <input type="text" name="periapical_no">
                <input type="checkbox" class="diagnosis-checkbox" data-code="O"> Occlusal <input type="text" name="occlusal_no">
            </div>
            <div class="submit-group">
                <button type="button" onclick="saveDiagnosis()">Save Diagnosis</button>
            </div>
        </form>
    </div>
</div>
</div>
<!-- ////////////////////////////////// Billing ////////////////-->

<div id="generate_billing" class="tab-content" style="display:none;">
    <!-- Overview content -->
    <div class="exam-details">
        <h3>Patient Records</h3>
        <form>
            <div>
                <p>{{ patient.first_name }} {{ patient.middle_name }} {{ patient.last_name }}
                    <span class="status-badge {{ 'inactive' if not patient.is_active else '' }}">{{ 'Active' if patient.is_active else 'Inactive' }}</span>
                </p>
                <button type="button" onclick="redirectToBilling({{ patient.patient_id }})">Go to Billing</button>
            </div>
        </form>
    </div>
</div>
</div>

<!-- Success and Error Modals -->
<div id="successModal" class="modal">
    <div class="modal-content">
        <span class="modal-close" onclick="closeModal('successModal')">&times;</span>
        <p id="successMessage"></p>
    </div>
</div>

<div id="errorModal" class="modal">
    <div class="modal-content">
        <span class="modal-close" onclick="closeModal('errorModal')">&times;</span>
        <p id="errorMessage"></p>
    </div>
</div>

<!-- Price Modal -->
<div id="priceModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal('priceModal')">&times;</span>
        <h2>Set Prices for Conditions</h2>
        <form id="priceForm">
            <div class="form-group">
                <label for="priceCl">Cleaning</label>
                <input type="number" id="priceCl" name="priceCl" min="0" step="0.01">
            </div>
            <div class="form-group">
                <label for="priceX">Extraction due to caries</label>
                <input type="number" id="priceX" name="priceX" min="0" step="0.01">
            </div>
            <div class="form-group">
                <label for="priceXO">Extraction due to other causes</label>
                <input type="number" id="priceXO" name="priceXO" min="0" step="0.01">
            </div>
            <div class="form-group">
                <label for="priceAm">Amalgam Filling</label>
                <input type="number" id="priceAm" name="priceAm" min="0" step="0.01">
            </div>
            <div class="form-group">
                <label for="priceCo">Composite Filling</label>
                <input type="number" id="priceCo" name="priceCo" min="0" step="0.01">
            </div>
            <div class="form-group">
                <label for="priceJC">Jacket Crown</label>
                <input type="number" id="priceJC" name="priceJC" min="0" step="0.01">
            </div>
            <div class="form-group">
                <label for="priceAb">Abutment</label>
                <input type="number" id="priceAb" name="priceAb" min="0" step="0.01">
            </div>
            <div class="form-group">
                <label for="priceAtt">Attachment</label>
                <input type="number" id="priceAtt" name="priceAtt" min="0" step="0.01">
            </div>
            <div class="form-group">
                <label for="priceP">Pontic</label>
                <input type="number" id="priceP" name="priceP" min="0" step="0.01">
            </div>
            <div class="form-group">
                <label for="priceIn">Inlay</label>
                <input type="number" id="priceIn" name="priceIn" min="0" step="0.01">
            </div>
            <div class="form-group">
                <label for="priceImp">Implant</label>
                <input type="number" id="priceImp" name="priceImp" min="0" step="0.01">
            </div>
            <div class="form-group">
                <label for="priceS">Sealants</label>
                <input type="number" id="priceS" name="priceS" min="0" step="0.01">
            </div>
            <div class="form-group">
                <label for="priceRm">Removable dentures</label>
                <input type="number" id="priceRm" name="priceRm" min="0" step="0.01">
            </div>
            <button type="button" onclick="savePrices()">Save Prices</button>
        </form>
    </div>
</div>

<!-- Modal for teeth conditions -->
<div id="conditionModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal('conditionModal')">&times;</span>
        <h2>Select Conditions</h2>
        <div class="legend">
            <div>
                <h3>Conditions:</h3>
                <label><input type="checkbox" class="condition-checkbox" data-code="Pt"> - Present Teeth</label><br>
                <label><input type="checkbox" class="condition-checkbox" data-code="D"> D - Decayed (Caries indicated for filling)</label><br>
                <label><input type="checkbox" class="condition-checkbox" data-code="M"> M - Missing due to caries</label><br>
                <label><input type="checkbox" class="condition-checkbox" data-code="MO"> MO - Missing due to other causes</label><br>
                <label><input type="checkbox" class="condition-checkbox" data-code="Sp"> Sp - Supernumerary Tooth</label><br>
                <label><input type="checkbox" class="condition-checkbox" data-code="Rf"> Rf - Roof Fragment</label><br>
                <label><input type="checkbox" class="condition-checkbox" data-code="Un"> Un - Unerupted</label><br>
            </div>
            <div>
                <h3>Surgery:</h3>
                <label><input type="checkbox" class="condition-checkbox" data-code="X"> X - Extraction due to caries</label><br>
                <label><input type="checkbox" class="condition-checkbox" data-code="XO"> XO - Extraction due to other causes</label><br>
            </div>
            <div>
                <h3>Restoration & Prosthetics</h3>
                <label><input type="checkbox" class="condition-checkbox" data-code="Cl"> Cl - Cleaning</label><br>
                <label><input type="checkbox" class="condition-checkbox" data-code="Am"> Am - Amalgam Filling</label><br>
                <label><input type="checkbox" class="condition-checkbox" data-code="Co"> Co - Composite Filling</label><br>
                <label><input type="checkbox" class="condition-checkbox" data-code="JC"> JC - Jacket Crown</label><br>
                <label><input type="checkbox" class="condition-checkbox" data-code="Ab"> Ab - Abutment</label><br>
                <label><input type="checkbox" class="condition-checkbox" data-code="Att"> Att - Attachment</label><br>
                <label><input type="checkbox" class="condition-checkbox" data-code="P"> P - Pontic</label><br>
                <label><input type="checkbox" class="condition-checkbox" data-code="In"> In - Inlay</label><br>
                <label><input type="checkbox" class="condition-checkbox" data-code="Imp"> Imp - Implant</label><br>
                <label><input type="checkbox" class="condition-checkbox" data-code="S"> S - Sealants</label><br>
                <label><input type="checkbox" class="condition-checkbox" data-code="Rm"> Rm - Removable dentures</label><br>
            </div>
        </div>
        <h3>Preview</h3>
        <p id="selectedConditions"></p>
        <div id="preview">
            <text id="previewText" x="50" y="55" text-anchor="middle" dominant-baseline="middle"></text>
        </div>
        <div>
            <svg viewBox="0 0 100 100" class="interactive-circle">
                <path class="segment" onclick="toggleSegment(this)" d="M50 50 L50 0 A50 50 0 0 1 100 50 z"></path>
                <path class="segment" onclick="toggleSegment(this)" d="M50 50 L100 50 A50 50 0 0 1 50 100 z"></path>
                <path class="segment" onclick="toggleSegment(this)" d="M50 50 L50 100 A50 50 0 0 1 0 50 z"></path>
                <path class="segment" onclick="toggleSegment(this)" d="M50 50 L0 50 A50 50 0 0 1 50 0 z"></path>
                <circle class="segment" onclick="toggleSegment(this)" cx="50" cy="50" r="20"></circle>
            </svg>
        </div>
        <button onclick="saveConditions()">Save</button>
    </div>
</div>

<script>
let currentTooth = null;
let prices = {};

function openTab(evt, tabName) {
    var i, tabcontent, tablinks;
    tabcontent = document.getElementsByClassName("tab-content");
    for (i = 0; i < tabcontent.length; i++) {
        tabcontent[i].style.display = "none";
    }
    tablinks = document.getElementsByClassName("tab");
    for (i = 0; i < tablinks.length; i++) {
        tablinks[i].className = tablinks[i].className.replace(" active", "");
    }
    document.getElementById(tabName).style.display = "block";
    evt.currentTarget.className += " active";
}

function openModal(toothElement, toothNumber) {
    currentTooth = toothElement;
    currentTooth.setAttribute('data-tooth-number', toothNumber);
    document.getElementById('conditionModal').style.display = 'block';
    loadConditions(toothNumber);
    loadSegments(toothNumber);
}

function openPriceModal() {
    document.getElementById('priceModal').style.display = 'block';
}

function closeModal(modalId) {
    document.getElementById(modalId).style.display = 'none';
}

function saveConditions() {
    const checkboxes = document.querySelectorAll('.condition-checkbox');
    let selectedCodes = [];
    checkboxes.forEach((checkbox) => {
        if (checkbox.checked) {
            selectedCodes.push({
                code: checkbox.getAttribute('data-code'),
                cost: prices[`price${checkbox.getAttribute('data-code')}`] || 0
            });
        }
    });
    const toothNumber = currentTooth.getAttribute('data-tooth-number');
    fetch('/conditions', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            tooth_number: toothNumber,
            condition_code: selectedCodes.map(c => c.code).join(','),
            patient_id: {{ patient.patient_id }}
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            displaySavedConditions(toothNumber, selectedCodes.map(c => c.code));
            closeModal('conditionModal');
        } else {
            alert('Failed to save conditions');
        }
    });
}

function displaySavedConditions(toothNumber, selectedCodes) {
    const toothBox = document.querySelector(`.tooth-box[data-tooth-number="${toothNumber}"]`);
    if (toothBox) {
        let conditionText = toothBox.querySelector('.condition-text');
        if (!conditionText) {
            conditionText = document.createElement('div');
            conditionText.className = 'condition-text';
            toothBox.appendChild(conditionText);
        }
        conditionText.textContent = selectedCodes.join(' ');
    }
}

function loadConditions(toothNumber) {
    fetch(`/conditions?patient_id={{ patient.patient_id }}`)
        .then(response => response.json())
        .then(data => {
            const storedConditions = data.filter(condition => condition.tooth_number == toothNumber).map(condition => condition.condition_code);
            const checkboxes = document.querySelectorAll('.condition-checkbox');
            checkboxes.forEach((checkbox) => {
                checkbox.checked = storedConditions.includes(checkbox.getAttribute('data-code'));
            });
            updatePreview();
        });
}

function updatePreview() {
    const checkboxes = document.querySelectorAll('.condition-checkbox:checked');
    let selectedCodes = [];
    checkboxes.forEach((checkbox) => {
        selectedCodes.push(checkbox.getAttribute('data-code'));
    });
    const previewText = document.getElementById('previewText');
    previewText.textContent = selectedCodes.join(' ');
}

function toggleSegment(segment) {
    if (segment.style.fill === 'red') {
        segment.style.fill = '#FFFFFF';
    } else {
        segment.style.fill = 'red';
    }
    saveSegments();
}

function saveSegments() {
    const segments = document.querySelectorAll('.segment');
    let selectedSegments = [];
    segments.forEach((segment, index) => {
        if (segment.style.fill === 'red') {
            selectedSegments.push(index);
        }
    });
    const toothNumber = currentTooth.getAttribute('data-tooth-number');
    localStorage.setItem(`tooth_${toothNumber}_segments`, JSON.stringify(selectedSegments));
}

function loadSegments(toothNumber) {
    const selectedSegments = JSON.parse(localStorage.getItem(`tooth_${toothNumber}_segments`)) || [];
    const segments = document.querySelectorAll('.segment');
    segments.forEach((segment, index) => {
        segment.style.fill = selectedSegments.includes(index) ? 'red' : '#FFFFFF';
    });
}

function showSuccessModal(message) {
    document.getElementById('successMessage').textContent = message;
    document.getElementById('successModal').style.display = 'block';
}

function showErrorModal(message) {
    document.getElementById('errorMessage').textContent = message;
    document.getElementById('errorModal').style.display = 'block';
}

function toggleTextBox(checkboxId, textBoxId) {
    const checkBox = document.getElementById(checkboxId);
    const textBox = document.getElementById(textBoxId);
    textBox.style.display = checkBox.checked ? 'block' : 'none';
}

function toggleDatePicker(checkboxId, datePickerId) {
    const checkBox = document.getElementById(checkboxId);
    const datePicker = document.getElementById(datePickerId);
    datePicker.style.display = checkBox.checked ? 'block' : 'none';
}

function saveMedicalHistory() {
    const formData = new FormData(document.getElementById('medicalHistoryForm'));
    const data = {};
    formData.forEach((value, key) => {
        data[key] = (value === 'on' || value === 'true') ? true : (value === 'false' ? false : value);
    });

    data['patient_id'] = {{ patient.patient_id }};  // Ensure you have the patient_id

    fetch('{{ url_for("save_medical_history") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSuccessModal('Medical history saved successfully.');
        } else {
            showErrorModal('Failed to save medical history: ' + data.error);
        }
    });
}

function saveDiagnosis() {
    const formData = new FormData(document.getElementById('diagnosisForm'));
    const data = {};
    formData.forEach((value, key) => {
        data[key] = value;
    });
    data['patient_id'] = {{ patient.patient_id }};

    fetch('{{ url_for("save_diagnosis") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSuccessModal('Diagnosis saved successfully.');
        } else {
            showErrorModal('Failed to save diagnosis: ' + data.error);
        }
    });
}

function savePrices() {
    const priceForm = document.getElementById('priceForm');
    const formData = new FormData(priceForm);
    formData.forEach((value, key) => {
        prices[key] = parseFloat(value);
    });
    closeModal('priceModal');
}

function updateBilling(selectedCodes) {
    const toothNumber = currentTooth.getAttribute('data-tooth-number');
    const patientId = {{ patient.patient_id }};
    selectedCodes.forEach(condition => {
        const cost = prices[`price${condition}`] || 0;
        fetch('/billing', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                patient_id: patientId,
                tooth_number: toothNumber,
                condition: condition,
                cost: cost
            })
        })
        .then(response => response.json())
        .then(data => {
            if (!data.success) {
                alert('Failed to update billing');
            }
        });
    });
}

document.addEventListener('DOMContentLoaded', function () {
    const sidebar = document.getElementById('sidebar');
    const sidebarTab = document.getElementById('sidebarTab');
    const mainContent = document.querySelector('.main-content');

    sidebarTab.addEventListener('click', function () {
        sidebar.classList.toggle('show');
        mainContent.classList.toggle('shifted');
        sidebarTab.style.display = 'none';
    });

    document.addEventListener('click', function (event) {
        if (!sidebar.contains(event.target) && !sidebarTab.contains(event.target)) {
            sidebar.classList.remove('show');
            mainContent.classList.remove('shifted');
            sidebarTab.style.display = 'block';
        }
    });

    const dropdowns = document.querySelectorAll('.dropdown');
    dropdowns.forEach(dropdown => {
        const btn = dropdown.querySelector('.ellipsis-btn');
        const content = dropdown.querySelector('.dropdown-content');


        btn.addEventListener('click', function (event) {
            event.stopPropagation();
            content.classList.toggle('show');
        });

        document.addEventListener('click', function () {
            content.classList.remove('show');
        });
    });

    // Initially hide conditional fields based on checkbox states
    const allergicCheckbox = document.getElementById('allergic');
    const allergicSpecify = document.getElementById('allergic-specify');
    allergicSpecify.style.display = allergicCheckbox.checked ? 'block' : 'none';

    const extractionCheckbox = document.getElementById('extraction');
    const extractionDate = document.getElementById('extraction-date');
    extractionDate.style.display = extractionCheckbox.checked ? 'block' : 'none';

    // Hide female-specific questions if patient is not female
    {% if patient.sex != 'Female' %}
        document.getElementById('menstruation').closest('.form-group').style.display = 'none';
        document.getElementById('pregnant').closest('.form-group').style.display = 'none';
    {% endif %}
});

function addItem() {
    const itemContainer = document.createElement('div');
    itemContainer.className = 'item-row';

    const itemDropdown = document.createElement('select');
    itemDropdown.className = 'item-dropdown';
    {% for item in items %}
    const option = document.createElement('option');
    option.value = "{{ item.id }}";
    option.textContent = "{{ item.name }}";
    itemDropdown.appendChild(option);
    {% endfor %}

    const itemQuantity = document.createElement('input');
    itemQuantity.type = 'number';
    itemQuantity.className = 'item-quantity';
    itemQuantity.placeholder = 'Quantity Used';

    const removeButton = document.createElement('button');
    removeButton.type = 'button';
    removeButton.className = 'remove-item-btn';
    removeButton.textContent = 'Remove';
    removeButton.onclick = function() {
        removeItem(removeButton);
    };

    itemContainer.appendChild(itemDropdown);
    itemContainer.appendChild(itemQuantity);
    itemContainer.appendChild(removeButton);

    document.getElementById('items-container').appendChild(itemContainer);
}

function removeItem(button) {
    button.parentElement.remove();
}

function redirectToBilling(patientId) {
    window.location.href = `/generate_billing/${patientId}`;
}

function clickMe() {
    let input = document.getElementById("popup");

    if (input.style.display == "none") {
        input.style.display = "block";
    } else {
        input.style.display = "none";
    }
}

document.querySelectorAll('.legend input[type="checkbox"]').forEach(checkbox => {
    checkbox.addEventListener('change', function () {
        const checkedBoxes = document.querySelectorAll('.legend input[type="checkbox"]:checked');
        const preview = document.getElementById('preview');

        if (checkedBoxes.length > 4) {
            this.checked = false;
            return;
        }
    });
});

</script>
    </div>
</body>
</html>
